<!-- templates/billing/dashboard.html -->
{% extends "core/base.html" %}
{% load humanize %}
{% block title %}Billing Dashboard{% endblock %}

{% block page_title %}Billing Dashboard{% endblock %}

{% block content %}
<!-- Metric Cards Grid -->
<div class="metrics-grid">
    <!-- Today's Revenue Card -->
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-icon-wrapper metric-icon-green">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"/>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
            </div>
            <span class="metric-label">Today's Revenue</span>
        </div>
        <div class="metric-value">₦{{ today_revenue|floatformat:2|intcomma|default:"0.00" }}</div>
    </div>

    <!-- Open Folios Card -->
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-icon-wrapper metric-icon-red">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
            </div>
            <span class="metric-label">Open Folios</span>
        </div>
        <div class="metric-value">{{ open_folios|default:"0" }}</div>
    </div>

    <!-- Partial Payments Card -->
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-icon-wrapper metric-icon-orange">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <span class="metric-label">Partial Payments</span>
        </div>
        <div class="metric-value">{{ partial_folios|default:"0" }}</div>
        <div class="metric-subtitle">Pending completion</div>
    </div>

    <!-- Settled Today Card -->
    <div class="metric-card">
        <div class="metric-header">
            <div class="metric-icon-wrapper metric-icon-blue">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>
            <span class="metric-label">Settled Today</span>
        </div>
        <div class="metric-value">{{ settled_today|default:"0" }}</div>
        <div class="metric-subtitle">Successfully completed</div>
    </div>
</div>

<!-- Payment Methods Chart -->
<div class="charts-grid">
    <div class="chart-card chart-card-medium">
        <div class="chart-header">
            <h3 class="chart-title">Payment Methods</h3>
        </div>
        <div class="chart-body">
            <canvas id="paymentMethodsChart"></canvas>
        </div>
    </div>

    <div class="chart-card chart-card-medium">
        <div class="chart-header">
            <h3 class="chart-title">Payment Status Overview</h3>
        </div>
        <div class="demographics-list">
            <div class="demographic-item">
                <div class="demographic-info">
                    <span class="demographic-color" style="background-color: #10B981;"></span>
                    <span class="demographic-label">Completed</span>
                </div>
                <span class="demographic-value">{{ settled_today|default:"0" }}</span>
            </div>
            <div class="demographic-item">
                <div class="demographic-info">
                    <span class="demographic-color" style="background-color: #F59E0B;"></span>
                    <span class="demographic-label">Partial</span>
                </div>
                <span class="demographic-value">{{ partial_folios|default:"0" }}</span>
            </div>
            <div class="demographic-item">
                <div class="demographic-info">
                    <span class="demographic-color" style="background-color: #EF4444;"></span>
                    <span class="demographic-label">Open</span>
                </div>
                <span class="demographic-value">{{ open_folios|default:"0" }}</span>
            </div>
        </div>
        <div class="chart-actions">
            <a href="{% url 'folio_list' %}" class="chart-action-link">
                View All Folios
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12"/>
                    <polyline points="12 5 19 12 12 19"/>
                </svg>
            </a>
        </div>
    </div>
</div>

<!-- Recent Transactions Table -->
<div class="transactions-card">
    <div class="transactions-header">
        <h3 class="transactions-title">Recent Transactions</h3>
        <a href="{% url 'accounting_report' %}" class="btn-view-report">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            View Report
        </a>
    </div>
    
    <div class="table-responsive">
        <table class="transactions-table">
            <thead>
                <tr>
                    <th>Guest</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
{% for payment in recent_payments %}
                <tr>
                    <td>
                        <div class="guest-cell">
                            <div class="guest-avatar">{{ payment.folio.guest.first_name.0 }}{{ payment.folio.guest.last_name.0 }}</div>
                            <span class="guest-name">{{ payment.folio.guest.first_name }} {{ payment.folio.guest.last_name }}</span>
                        </div>
                    </td>
                    <td class="amount-cell">₦{{ payment.amount|floatformat:2|intcomma }}</td>
                    <td class="method-cell">{{ payment.get_payment_method_display }}</td>
                    <td>
{% if payment.status == 'completed' %}
                        <span class="status-badge status-success">{{ payment.get_status_display }}</span>
{% elif payment.status == 'pending' %}
                        <span class="status-badge status-warning">{{ payment.get_status_display }}</span>
{% else %}
                        <span class="status-badge status-danger">{{ payment.get_status_display }}</span>
{% endif %}
                    </td>
                    <td class="date-cell">{{ payment.created_at|date:"M d, H:i" }}</td>
                </tr>
{% empty %}
                <tr>
                    <td colspan="5" class="empty-row">
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="1" y="4" width="22" height="16" rx="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                            <p>No transactions today</p>
                        </div>
                    </td>
                </tr>
{% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    
        const paymentData = {{ payment_methods_data|safe }};
    
        const labels = Object.keys(paymentData).map(
            key => `${key} - ${paymentData[key]}%`
        );
    
        const values = Object.values(paymentData);
    
        const ctx = document
            .getElementById('paymentMethodsChart')
            .getContext('2d');
    
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        '#10B981', // Cash
                        '#3B82F6', // Card
                        '#F59E0B', // Bank Transfer
                        '#8B5CF6', // Paystack
                        '#EF4444'  // Cheque
                    ],
                    borderWidth: 0,
                    spacing: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            color: '#6B7280'
                        }
                    }
                }
            }
        });
    
    });
    </script>
{% endblock %}